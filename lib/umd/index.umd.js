!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("assert")):"function"==typeof define&&define.amd?define(["assert"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).Mud=e(t.assert)}(this,(function(t){"use strict";function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=e(t);var n=class{constructor(t={},e=null){this.record=t,this.parent=e}define(t,e){return this.record[t]=e,e}lookUp(t){return this.resolve(t).record[t]}resolve(t){if(this.record.hasOwnProperty(t))return this;if(null===this.parent)throw new ReferenceError(`Variable ${t} is not defined.`);return this.parent.resolve(t)}assign(t,e){return this.resolve(t).record[t]=e,e}};var s=class{transformSwitch(t){const[e,...r]=t,n=["if",null,null,null];let s=n;for(let t=0;t<r.length-1;t++){const[e,n]=r[t],[i,o]=r[t+1];s[1]=e,s[2]=n,s[3]="default"===i?o:["if",null,null,null],s=s[3]}return n}};let i,o,l={};const u=[[-1,1,t=>{o=t}],[0,1,t=>{o=t}],[0,1,t=>{o=t}],[0,1,t=>{o=t}],[0,1,t=>{o=t}],[1,1,t=>{o=Number(t)}],[1,1,t=>{o=t}],[1,1,t=>{o=t}],[2,3,(t,e,r)=>{o=e}],[3,2,(t,e)=>{t.push(e),o=t}],[3,0,()=>{o=[]}],[4,3,(t,e,r)=>{e.unshift("block"),o=e}],[5,2,(t,e)=>{t.push(e),o=t}],[5,0,()=>{o=[]}],[6,4,(t,e,r,n)=>{o=["prop",t,r]}],[7,1,t=>{o=t}],[7,1,t=>{o=t}],[7,1,t=>{o=Number(t)}],[7,1,t=>{o=t}]],a={NUMBER:"8",STRING:"9",SYMBOL:"10","'('":"11","')'":"12","'{'":"13","'}'":"14","'['":"15","']'":"16",$:"17"},h=[{0:1,1:2,2:3,4:4,6:5,8:"s6",9:"s7",10:"s8",11:"s9",13:"s10"},{17:"acc"},{8:"r1",9:"r1",10:"r1",11:"r1",12:"r1",13:"r1",14:"r1",15:"s11",17:"r1"},{8:"r2",9:"r2",10:"r2",11:"r2",12:"r2",13:"r2",14:"r2",17:"r2"},{8:"r3",9:"r3",10:"r3",11:"r3",12:"r3",13:"r3",14:"r3",17:"r3"},{8:"r4",9:"r4",10:"r4",11:"r4",12:"r4",13:"r4",14:"r4",17:"r4"},{8:"r5",9:"r5",10:"r5",11:"r5",12:"r5",13:"r5",14:"r5",15:"r5",17:"r5"},{8:"r6",9:"r6",10:"r6",11:"r6",12:"r6",13:"r6",14:"r6",15:"r6",17:"r6"},{8:"r7",9:"r7",10:"r7",11:"r7",12:"r7",13:"r7",14:"r7",15:"r7",17:"r7"},{3:18,8:"r10",9:"r10",10:"r10",11:"r10",12:"r10",13:"r10"},{5:21,8:"r13",9:"r13",10:"r13",11:"r13",13:"r13",14:"r13"},{2:13,7:12,8:"s15",9:"s14",10:"s16",11:"s9"},{16:"s17"},{16:"r15"},{16:"r16"},{16:"r17"},{16:"r18"},{8:"r14",9:"r14",10:"r14",11:"r14",12:"r14",13:"r14",14:"r14",17:"r14"},{0:20,1:2,2:3,4:4,6:5,8:"s6",9:"s7",10:"s8",11:"s9",12:"s19",13:"s10"},{8:"r8",9:"r8",10:"r8",11:"r8",12:"r8",13:"r8",14:"r8",16:"r8",17:"r8"},{8:"r9",9:"r9",10:"r9",11:"r9",12:"r9",13:"r9"},{0:23,1:2,2:3,4:4,6:5,8:"s6",9:"s7",10:"s8",11:"s9",13:"s10",14:"s22"},{8:"r11",9:"r11",10:"r11",11:"r11",12:"r11",13:"r11",14:"r11",17:"r11"},{8:"r12",9:"r12",10:"r12",11:"r12",13:"r12",14:"r12"}],c=[];let f;const p=[[/^\(/,function(){return"'('"}],[/^\)/,function(){return"')'"}],[/^\{/,function(){return"'{'"}],[/^\}/,function(){return"'}'"}],[/^\[/,function(){return"'['"}],[/^\]/,function(){return"']'"}],[/^\s+/,function(){}],[/^"([^\"\\]*(\\.[^\"\\]*)*)"/,function(){return"STRING"}],[/^\d+/,function(){return"NUMBER"}],[/^[\w\-+*=<>/]+/,function(){return"SYMBOL"}],[/^\{/,function(){return"LBRACE"}],[/^\}/,function(){return"RBRACE"}]],d={INITIAL:[0,1,2,3,4,5,6,7,8,9,10,11]},_={type:"$",value:""};f={initString(t){return this._string=t,this._cursor=0,this._states=["INITIAL"],this._tokensQueue=[],this._currentLine=1,this._currentColumn=0,this._currentLineBeginOffset=0,this._tokenStartOffset=0,this._tokenEndOffset=0,this._tokenStartLine=1,this._tokenEndLine=1,this._tokenStartColumn=0,this._tokenEndColumn=0,this},getStates(){return this._states},getCurrentState(){return this._states[this._states.length-1]},pushState(t){this._states.push(t)},begin(t){this.pushState(t)},popState(){return this._states.length>1?this._states.pop():this._states[0]},getNextToken(){if(this._tokensQueue.length>0)return this.onToken(this._toToken(this._tokensQueue.shift()));if(!this.hasMoreTokens())return this.onToken(_);let t=this._string.slice(this._cursor),e=d[this.getCurrentState()];for(let r=0;r<e.length;r++){let n=e[r],s=p[n],o=this._match(t,s[0]);if(""===t&&""===o&&this._cursor++,null!==o){i=o,i.length;let t=s[1].call(this);if(!t)return this.getNextToken();if(Array.isArray(t)){const e=t.slice(1);t=t[0],e.length>0&&this._tokensQueue.unshift(...e)}return this.onToken(this._toToken(t,i))}}if(this.isEOF())return this._cursor++,_;this.throwUnexpectedToken(t[0],this._currentLine,this._currentColumn)},throwUnexpectedToken(t,e,r){const n=this._string.split("\n")[e-1];let s="";if(n){s="\n\n"+n+"\n"+" ".repeat(r)+"^\n"}throw new SyntaxError(`${s}Unexpected token: "${t}" at ${e}:${r}.`)},getCursor(){return this._cursor},getCurrentLine(){return this._currentLine},getCurrentColumn(){return this._currentColumn},_captureLocation(t){const e=/\n/g;let r;for(this._tokenStartOffset=this._cursor,this._tokenStartLine=this._currentLine,this._tokenStartColumn=this._tokenStartOffset-this._currentLineBeginOffset;null!==(r=e.exec(t));)this._currentLine++,this._currentLineBeginOffset=this._tokenStartOffset+r.index+1;this._tokenEndOffset=this._cursor+t.length,this._tokenEndLine=this._currentLine,this._tokenEndColumn=this._currentColumn=this._tokenEndOffset-this._currentLineBeginOffset},_toToken(t,e=""){return{type:t,value:e,startOffset:this._tokenStartOffset,endOffset:this._tokenEndOffset,startLine:this._tokenStartLine,endLine:this._tokenEndLine,startColumn:this._tokenStartColumn,endColumn:this._tokenEndColumn}},isEOF(){return this._cursor===this._string.length},hasMoreTokens(){return this._cursor<=this._string.length},_match(t,e){let r=t.match(e);return r?(this._captureLocation(r[0]),this._cursor+=r[0].length,r[0]):null},onToken:t=>t},l.lexer=f,l.tokenizer=f,l.options={captureLocations:!1};const g={setOptions(t){return l.options=t,this},getOptions:()=>l.options,parse(t,e){if(!f)throw new Error("Tokenizer instance wasn't specified.");f.initString(t);let r=l.options;e&&(l.options=Object.assign({},l.options,e)),c.length=0,c.push(0);let n=f.getNextToken(),s=null;do{n||(l.options=r,m());let t=c[c.length-1],e=a[n.type];h[t].hasOwnProperty(e)||(l.options=r,k(n));let p=h[t][e];if("s"===p[0]){let t=null;l.options.captureLocations&&(t={startOffset:n.startOffset,endOffset:n.endOffset,startLine:n.startLine,endLine:n.endLine,startColumn:n.startColumn,endColumn:n.endColumn}),s=this.onShift(n),c.push({symbol:a[s.type],semanticValue:s.value,loc:t},Number(p.slice(1))),n=f.getNextToken()}else if("r"===p[0]){let t=p.slice(1),e=u[t],r="function"==typeof e[2],n=r?[]:null;const a=r&&l.options.captureLocations?[]:null;if(0!==e[1]){let t=e[1];for(;t-- >0;){c.pop();let t=c.pop();r&&(n.unshift(t.semanticValue),a&&a.unshift(t.loc))}}const f={symbol:e[0]};if(r){i=s?s.value:null,s&&s.value.length;const t=null!==a?n.concat(a):n;e[2](...t),f.semanticValue=o,a&&(f.loc=undefined)}const d=c[c.length-1],_=e[0];c.push(f,h[d][_])}else if("acc"===p){c.pop();let t=c.pop();return(1!==c.length||0!==c[0]||f.hasMoreTokens())&&(l.options=r,k(n)),t.hasOwnProperty("semanticValue")?(l.options=r,g.onParseEnd(t.semanticValue),t.semanticValue):(l.options=r,!0)}}while(f.hasMoreTokens()||c.length>1)},setTokenizer:t=>(f=t,g),getTokenizer:()=>f,onParseBegin(t,e,r){},onParseEnd(t){},onShift:t=>t};function k(t){"$"===t.type&&m(),f.throwUnexpectedToken(t.value,t.startLine,t.startColumn)}function m(){!function(t){throw new SyntaxError(t)}("Unexpected end of input.")}var v=g;const y="HERE_IS_NO_EXPECTED, WHY?";var w=class{constructor(t){this.nighta=t}parse(t){return v.parse(t)}parseTest(t,e=y){const n=this.parse(t);e===y?r.default.doesNotThrow((()=>this.nighta.eval(n))):r.default.strictEqual(this.nighta.eval(n),e)}};return new class{constructor(t=new n,e=null){this.global=t,this.parent=e,this.transformer=new s,this.parser=new w(this)}parse(t){return this.parser.parse(`{${t}}`)}eval(t,e=this.global){if(console.log("======================================"),console.log(t),console.log("____"),this._isNumber(t))return t;if(this._isString(t))return t.slice(1,-1);if(!this._isUndefined(t)){if("block"===t[0]){const r=new n({},e);return this._evalBlock(t,r)}if("var"===t[0]){const[r,n,s]=t;return e.define(n,this.eval(s,e))}if("if"===t[0]){const[r,n,s,i]=t;return this.eval(n,e)?this.eval(s,e):this.eval(i,e)}if("switch"===t[0]){const r=this.transformer.transformSwitch(t);return this.eval(r,e)}if("while"===t[0]){const[r,n,s]=t;let i;for(;this.eval(n,e);)i=this.eval(s,e);return i}if("fun"===t[0]){if(4===t.length){const[r,n,s,i]=t;return e.define(n,{params:s,body:i,env:e})}{const[r,n,s]=t;return{params:n,body:s,env:e}}}if("class"===t[0]){const[r,s,i,o]=t,l=this.eval(i,e),u=new n({_className:s},l||e);return l&&Object.keys(l.record).forEach((t=>{const e=l.record[t],r=u.record[t];let n;if("constructor"===t){const s=["block",[...e?.body?.[1]??[],...r.body?.[1]??[]]];n={params:[...e.params,...r?.params??[]],body:s,env:l},u.define(t,n)}else n=r??e;u.define(t,n)})),this._evalFunctionBody(o,u),e.define(s,u)}if("new"===t[0]){const[r,s,...i]=t,o=this.eval(s,e),l=new n({},o);l.define("self",l);const u={...o.parent?.record,...o.record};Object.keys(u).forEach((t=>{const e=u[t];let r;e instanceof Object?(r={...e},r.env&&(r.env=l)):r=e,l.define(t,r)}));const a=l.lookUp("constructor"),h=i.map((t=>this.eval(t,e)));return this._callUserDefinedFunction(a,h,l),l}if("prop"===t[0]){const[r,n,s]=t,i=this.eval(n,e);let o;return o=this._isString(s)?s.slice(1,-1):this.eval(s,e),i.lookUp(o)}if("super"===t[0]){const[r,n]=t;return this.eval(n,e).parent}if(this._isVariableName(t))return e.lookUp(t);if(Array.isArray(t)){let r,n;if("="===t[1]){const[r,n,s]=t,i=this.eval(s,e);if("prop"===r[0]){const[t,n,s]=r,o=this.eval(n,e);let l;return l=this._isString(s)?s.slice(1,-1):this.eval(s,e),o.define(l,i)}return e.assign(r,i)}if(["+","-","*","/","%","&&","||","&","|",">",">=","==","<=","<"].includes(t[1])){const[e,s,i]=t;r=s,n=[e,i]}else[r,...n]=t;const s=this.eval(r,e),i=n.map((t=>this.eval(t,e)));if("function"==typeof s)return s(...i);if(s.body&&s.env)return this._callUserDefinedFunction(s,i,s.env)}throw`Unimplemented Syntax: ${JSON.stringify(t)}`}}_callUserDefinedFunction(t,e,r){const s={};t.params?.forEach(((t,r)=>{s[t]=e[r]}));const i=new n(s,r);return this._evalFunctionBody(t.body,i)}_evalFunctionBody(t,e){return"block"===t[0]?this._evalBlock(t,e):this.eval(t,e)}_evalBlock(t,e){let r;const[n,...s]=t;return s.forEach((t=>{r=this.eval(t,e)})),r}_isNumber(t){return"number"==typeof t}_isString(t){return"string"==typeof t&&'"'===t[0]&&'"'===t.slice(-1)}_isUndefined(t){return void 0===t}_isVariableName(t){return"string"==typeof t&&/^[+\-*/<>=a-zA-Z0-9_]*$/.test(t)}}(new n({null:null,true:!0,false:!1,undefined:void 0,"+":(t,e)=>t+e,"-":(t,e)=>t-e,"*":(t,e)=>t*e,"/":(t,e)=>t/e,"%":(t,e)=>t%e,">":(t,e)=>t>e,">=":(t,e)=>t>=e,"==":(t,e)=>t===e,"<=":(t,e)=>t<=e,"<":(t,e)=>t<e,"&&":(t,e)=>t&&e,"||":(t,e)=>t||e,"&":(t,e)=>t&e,"|":(t,e)=>t|e,say:(...t)=>{let e;return t.length>1?(e=t.reduce(((t,e)=>t+e),""),console.log(e)):(e=t[0],console.dir(e,{depth:null})),e},Array:()=>{}}))})),"undefined"!=typeof window&&(window.MUD_VERSION="0.0.1");
